<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Checkout | Sunny Sugar Art</title>
<style>
  :root{ --ink:#1f1b14; --muted:#6b5f4a; --line:#efe5c9; --brand:#4b3a2b; --accent:#fbc02d; }
  *{box-sizing:border-box}
  body{margin:0;font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--ink);background:#fff}
  header{padding:16px 22px;border-bottom:1px solid var(--line);display:flex;gap:16px;align-items:center}
  header a{font-weight:800;color:var(--brand);text-decoration:none}
  .wrap{max-width:1000px;margin:0 auto;padding:24px}
  h1{margin:0 0 16px}
  .grid{display:grid;grid-template-columns:2fr 1fr;gap:24px}
  @media (max-width:900px){.grid{grid-template-columns:1fr}}
  .card{border:1px solid #f2ecd7;border-radius:14px;overflow:hidden;background:#fff}
  .card h2{margin:0;padding:14px 16px;border-bottom:1px solid #f5f0e2;font-size:1.1rem}
  .card .body{padding:16px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid #f3efe3;text-align:left;vertical-align:top}
  th{background:#faf7f0}
  tfoot td{border-top:2px solid #eadfbe;font-weight:900}
  .right{text-align:right}
  .muted{color:var(--muted)}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .row > div{display:flex;flex-direction:column}
  label{font-weight:800;margin:6px 0}
  input,textarea,select{font:inherit;padding:10px;border:1px solid #e9e1c7;border-radius:10px}
  textarea{min-height:86px;resize:vertical}
  .btn{display:inline-block;padding:12px 18px;border-radius:999px;font-weight:900;text-decoration:none;cursor:pointer}
  .btn.back{background:#fff;border:2px solid var(--brand);color:var(--brand);margin-right:8px}
  .btn.primary{background:var(--accent);border:2px solid var(--accent);color:#2a2100}
  .success{padding:18px;border:1px solid #c7f2c2;background:#eafbea;border-radius:12px;margin-bottom:16px;display:none}
  .error{padding:12px;border:1px solid #ffd1cd;background:#fff3f2;border-radius:10px;margin-bottom:12px;display:none}
</style>
</head>
<body>
<header>
  <a href="cart.html">← Back to Cart</a>
  <strong>Sunny Sugar Art</strong>
</header>

<div class="wrap">
  <h1>Checkout</h1>
  <div id="notice-empty" class="error" style="display:none">Your cart is empty. Please add some cookies first.</div>
  <div id="notice-success" class="success"></div>

  <div class="grid" id="checkout-grid" style="display:none">
    <!-- Order Summary -->
    <section class="card">
      <h2>Order Summary</h2>
      <div class="body">
        <table id="summary">
          <thead>
            <tr>
              <th>Item</th>
              <th class="right">Qty</th>
              <th class="right">Unit</th>
              <th class="right">Subtotal</th>
            </tr>
          </thead>
          <tbody id="summary-body"></tbody>
          <tfoot>
            <tr>
              <td colspan="3" class="right">Total</td>
              <td class="right" id="summary-total">A$ 0.00</td>
            </tr>
          </tfoot>
        </table>
        <p class="muted">Prices are in AUD. Hand-piped to order — please allow lead time during peak seasons.</p>
      </div>
    </section>

    <!-- Customer Details / Payment -->
    <section class="card">
      <h2>Your Details</h2>
      <div class="body">
        <form id="checkout-form">
          <div class="row">
            <div>
              <label for="name">Full name</label>
              <input id="name" required />
            </div>
            <div>
              <label for="email">Email</label>
              <input id="email" type="email" required />
            </div>
          </div>
          <div class="row">
            <div>
              <label for="phone">Phone</label>
              <input id="phone" type="tel" />
            </div>
            <div>
              <label for="date">Preferred pickup/delivery date</label>
              <input id="date" type="date" />
            </div>
          </div>
          <div>
            <label for="address">Address (optional)</label>
            <textarea id="address" placeholder="Street, suburb, postcode…"></textarea>
          </div>
          <div>
            <label for="notes">Order notes</label>
            <textarea id="notes" placeholder="Colour notes, allergy info, message on cookie, etc."></textarea>
          </div>

          <div style="margin:12px 0 16px">
            <label>Payment</label>
            <div>
              <label><input type="radio" name="pay" value="card" checked /> Pay with card (demo)</label><br>
              <label><input type="radio" name="pay" value="bank" /> Bank transfer (manual)</label>
            </div>
          </div>

          <div>
            <a class="btn back" href="cart.html">← Back to Cart</a>
            <button class="btn primary" type="submit">Pay & Place Order</button>
          </div>
        </form>
      </div>
    </section>
  </div>
</div>

<!-- 必須先載入你的購物車工具 -->
<script src="js/cart.js"></script>
<script>
/* ===== 讀取購物車（使用 SSA_CART / cents）並渲染摘要 ===== */
function renderSummary(){
  const cart = SSA_CART.getCart(); // 陣列：[{title, unitPrice(cents), qty, packLabel, flavour, colourNote, image, id}]
  if(!cart || cart.length===0){
    document.getElementById('notice-empty').style.display='block';
    document.getElementById('checkout-grid').style.display='none';
    return;
  }
  document.getElementById('checkout-grid').style.display='grid';

  const tbody = document.getElementById('summary-body');
  tbody.innerHTML = '';
  cart.forEach(it=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>
        <div style="font-weight:800">${it.title||'Cookie'}</div>
        <div class="muted" style="font-size:.9rem">
          ${it.packLabel?`Pack: ${it.packLabel} · `:''}
          ${it.flavour?`Flavour: ${it.flavour} · `:''}
          ${it.colourNote?`Colour: ${it.colourNote}`:''}
        </div>
      </td>
      <td class="right">${it.qty||1}</td>
      <td class="right">${SSA_CART.formatAUD(it.unitPrice||0)}</td>
      <td class="right">${SSA_CART.formatAUD((it.unitPrice||0)*(it.qty||1))}</td>
    `;
    tbody.appendChild(tr);
  });

  document.getElementById('summary-total').textContent = SSA_CART.formatAUD(SSA_CART.cartSubtotalCents());
}

/* ===== 訂單儲存（localStorage demo 後台） ===== */
const ORDERS_KEY = 'ssa_orders';
function loadOrders(){ try{return JSON.parse(localStorage.getItem(ORDERS_KEY))||[];}catch(e){return[];} }
function saveOrders(list){ localStorage.setItem(ORDERS_KEY, JSON.stringify(list)); }
function genOrderId(){
  const d=new Date();
  const y=String(d.getFullYear()).slice(-2);
  const m=String(d.getMonth()+1).padStart(2,'0');
  const day=String(d.getDate()).padStart(2,'0');
  const rand=Math.random().toString(36).slice(2,6).toUpperCase();
  return `SSA-${y}${m}${day}-${rand}`;
}

/* ===== 送出訂單（demo：不實際刷卡，直接建立訂單記錄） ===== */
document.getElementById('checkout-form').addEventListener('submit', (e)=>{
  e.preventDefault();
  const cart = SSA_CART.getCart();
  if(!cart.length){ alert('Your cart is empty.'); return; }

  const order = {
    id: genOrderId(),
    createdAt: new Date().toISOString(),
    items: cart,                              // 原樣存檔（含 title / unitPrice(cents) / qty / packLabel / flavour / colourNote）
    totalCents: SSA_CART.cartSubtotalCents(), // 以 cents 存
    customer: {
      name:  document.getElementById('name').value.trim(),
      email: document.getElementById('email').value.trim(),
      phone: document.getElementById('phone').value.trim(),
      date:  document.getElementById('date').value,
      address: document.getElementById('address').value.trim(),
      notes: document.getElementById('notes').value.trim(),
      payMethod: (document.querySelector('input[name="pay"]:checked')||{}).value || 'card'
    },
    status: 'paid' // demo：直接設為已付款；若將來串金流，改成 pending -> paid
  };

  const list = loadOrders();
  list.unshift(order);
  saveOrders(list);

  // 清空購物車
  SSA_CART.clearCart();

  // 完成提示（頁內）
  const box = document.getElementById('notice-success');
  box.innerHTML = `✅ Order placed! Your order number is <strong>${order.id}</strong>.<br/>
  Total: <strong>${SSA_CART.formatAUD(order.totalCents)}</strong> · A confirmation email will be sent by Sunny (manual for now).`;
  box.style.display = 'block';

  // 隱藏主要內容
  document.getElementById('checkout-grid').style.display = 'none';
  box.scrollIntoView({behavior:'smooth'});
});

/* INIT */
document.addEventListener('DOMContentLoaded', ()=>{
  renderSummary();
  SSA_CART.updateCartBadge?.();
});
</script>
</body>
  /* === Checkout layout fixes (override) === */
.wrap{ max-width: 1120px; }                 /* 略放大容器 */
.grid{
  display:grid;
  grid-template-columns: 1.7fr 1fr;         /* 左寬右窄，避免表單擠在一起 */
  gap: 28px;
}
@media (max-width: 980px){
  .grid{ grid-template-columns: 1fr; }      /* 平板以下改單欄 */
}

/* 卡片與標題層級微調 */
.card{ border-radius:14px; }
.card h2{ font-size:1.125rem; padding:16px; }
.card .body{ padding:18px; }

/* 表格字級與行高一致，避免擠壓 */
table{ width:100%; border-collapse:collapse; font-size:.95rem; }
th, td{ padding:12px; line-height:1.5; }
th{ background:#faf7f0; font-weight:800; }
tfoot td{ font-size:1rem; }

/* 右側表單欄位拉寬、字級一致 */
label{ font-weight:800; margin:6px 0 6px; }
input, select, textarea{
  width:100%;
  font-size:1rem;
  padding:11px 12px;
  border:1px solid #e9e1c7;
  border-radius:10px;
}
textarea{ min-height:92px; }

/* 兩欄欄位在寬螢幕拉開一點、窄螢幕落單欄 */
.row{ display:grid; grid-template-columns: 1fr 1fr; gap:14px; }
@media (max-width: 720px){ .row{ grid-template-columns: 1fr; } }

/* 按鈕大小與間距一致 */
.btn{ padding:12px 18px; font-weight:900; border-radius:999px; }
.btn.back{ margin-right:10px; }

</html>
